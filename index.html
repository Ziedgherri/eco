<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منصة مساعدة التلاميذ</title>
<style>
body{font-family:Arial;margin:0;background:#f3f4f6;direction:rtl;}
nav{background:#1e3a8a;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
button{padding:8px 15px;background:#2563eb;border:none;color:white;cursor:pointer;border-radius:20px;margin-top:5px;}
input, select, textarea{width:100%;padding:8px;margin-top:8px;border-radius:10px;border:1px solid #ccc;}
.container{padding:20px;}
.card{padding:15px;margin-top:15px;border-radius:15px;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
.solutionCard{padding:10px;margin-top:8px;border-radius:10px;}
.hidden{display:none;}
.tip{background:#fffbcc;border-left:5px solid #f59e0b;padding:10px;margin:10px 0;}
</style>
</head>
<body>

<nav>
<h2>منصة مساعدة التلاميذ</h2>
<div id="userArea"></div>
</nav>

<div class="container" id="loginPage">
<h2>تسجيل الدخول / إنشاء حساب</h2>
<div class="tip">
<b>تلميحات مهمة:</b> 
<ul>
<li>يجب استخدام بريدك الإلكتروني الحقيقي لتلقي رسالة التحقق.</li>
<li>لن تتمكن من استخدام المنصة قبل تأكيد البريد.</li>
<li>الاسم الذي تختاره عند إنشاء الحساب سيظل ثابتًا لكل تسجيل دخول.</li>
<li>يمكنك إعادة إرسال رسالة التحقق إذا لم تصل.</li>
</ul>
</div>
<input id="displayName" placeholder="أدخل اسمك عند إنشاء الحساب">
<input id="email" placeholder="أدخل البريد الإلكتروني" type="email">
<input id="password" placeholder="أدخل كلمة المرور" type="password">
<button onclick="login()">دخول</button>
<button onclick="register()">إنشاء حساب</button>
<button onclick="resendVerification()">إعادة إرسال التحقق</button>
</div>

<div class="container hidden" id="mainPage">

<h2>إضافة مشكلة</h2>
<input id="problemText" placeholder="اكتب مشكلتك">
<input id="problemPrice" placeholder="كم المبلغ مقابل الحل؟">

<select id="problemYear" onchange="updateSections(); updateSubjects()">
<option value="">اختر السنة الدراسية</option>
<option value="1ère">1ère</option>
<option value="2ème">2ème</option>
<option value="3ème">3ème</option>
<option value="4ème/Bac">4ème/Bac</option>
</select>

<select id="problemSection" onchange="updateSubjects()">
<option value="">اختر الشعبة</option>
</select>

<select id="problemSubject">
<option value="">اختر المادة</option>
</select>

<button onclick="addProblem()">إضافة المشكلة</button>

<h2 style="margin-top:40px;">قائمة المشاكل</h2>
<div id="problemsList"></div>

</div>

<!-- Private Messaging Sidebar -->
<div id="dmSidebar" class="hidden" style="position:fixed;top:0;right:0;width:50%;height:100%;background:white;box-shadow:-4px 0 8px rgba(0,0,0,0.1);overflow:auto;z-index:9999;transition:transform 0.3s;transform:translateX(100%);">
    <div style="padding:10px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ccc;">
        <h3>الرسائل الخاصة</h3>
        <button onclick="closeDM()">إغلاق</button>
    </div>
    <div style="display:flex;height:calc(100% - 50px);">
        <div id="dmUsersList" style="width:35%;border-right:1px solid #ccc;overflow:auto;"></div>
        <div id="dmChatArea" style="width:65%;padding:10px;display:flex;flex-direction:column;justify-content:flex-end;overflow:auto;"></div>
    </div>
</div>

<!-- DM Button -->
<button id="openDMBtn" style="position:fixed;bottom:20px;left:20px;background:#2563eb;color:white;padding:10px 15px;border-radius:50px;z-index:1000;" onclick="openDM()">الرسائل الخاصة</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
// Firebase config
const firebaseConfig = {
apiKey: "AIzaSyB4J_b-9NSV_JA678xp8m71nZ2_7I1TKbw",
authDomain: "emeco2.firebaseapp.com",
databaseURL: "https://emeco2-default-rtdb.firebaseio.com/",
projectId: "emeco2",
storageBucket: "emeco2.firebasestorage.app",
messagingSenderId: "961569608008",
appId: "1:961569608008:web:1dc2fa016a1a634e70637d",
measurementId: "G-12CX368R40"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
const adminEmail = "gherrizied@gmail.com"; // حساب Admin

// ألوان خلفيات عشوائية
const cardColors = ["#fef3c7","#fde68a","#fcd34d","#fbbf24","#f59e0b","#f97316","#fb923c","#f87171","#f472b6","#c084fc","#8b5cf6","#60a5fa","#34d399","#86efac"];
function getRandomColor(){return cardColors[Math.floor(Math.random()*cardColors.length)];}

// دالة لحساب الوقت منذ النشر
function timeSince(timestamp){
    const now = Date.now();
    const seconds = Math.floor((now - timestamp)/1000);
    if(seconds < 60) return `${seconds} ثانية مضت`;
    const minutes = Math.floor(seconds/60);
    if(minutes < 60) return `${minutes} دقيقة مضت`;
    const hours = Math.floor(minutes/60);
    if(hours < 24) return `${hours} ساعة مضت`;
    const days = Math.floor(hours/24);
    if(days < 30) return `${days} يوم مضى`;
    const months = Math.floor(days/30);
    if(months < 12) return `${months} شهر مضى`;
    const years = Math.floor(months/12);
    return `${years} سنة مضت`;
}

// الهيكل الأساسي للسنة والشعبة والمواد
const yearSections = {
"1ère":[""],
"2ème":["Eco","Lettres","Info","Science","Sport"],
"3ème":["Eco","Lettres","Info","Science","Sport","Technique","Math"],
"4ème/Bac":["Eco","Lettres","Info","Science","Sport","Technique","Math"]
};
const subjectsBySection = {
"1ère":["Math","Arabic","French","Physics","Chemistry","History","Geography","Biology","Philosophy","Economics","Sport","Informatics"],
"2ème":{"Eco":["Math","Arabic","Economics","French","History","Geography","Physics","Chemistry","Biology","Philosophy","Informatics","Sport"],
"Lettres":["Arabic","French","History","Philosophy","Geography","Physics","Chemistry","Biology","Economics","Informatics","Sport"],
"Info":["Math","Informatics","Physics","Arabic","Chemistry","Biology","French","Economics","History","Sport"],
"Science":["Math","Physics","Chemistry","Biology","Arabic","Informatics","French","Economics","History","Sport"],
"Sport":["Sport","Biology","Arabic","Math","Physics","Chemistry","French","Informatics","Economics","History"]
},
"3ème":{"Eco":["Math","Arabic","Economics","French","History","Geography","Physics","Chemistry","Biology","Philosophy","Informatics","Sport"],
"Lettres":["Arabic","French","History","Philosophy","Geography","Physics","Chemistry","Biology","Economics","Informatics","Sport"],
"Info":["Math","Informatics","Physics","Arabic","Chemistry","Biology","French","Economics","History","Sport"],
"Science":["Math","Physics","Chemistry","Biology","Arabic","Informatics","French","Economics","History","Sport"],
"Sport":["Sport","Biology","Arabic","Math","Physics","Chemistry","French","Informatics","Economics","History"],
"Technique":["Math","Physics","Chemistry","Arabic","Informatics","French","Biology","Economics","History","Geography","Sport"],
"Math":["Math","Physics","Arabic","Chemistry","Biology","French","Informatics","Economics","History","Geography","Sport"]
},
"4ème/Bac":{"Eco":["Math","Arabic","Economics","French","History","Geography","Physics","Chemistry","Biology","Philosophy","Informatics","Sport"],
"Lettres":["Arabic","French","History","Philosophy","Geography","Physics","Chemistry","Biology","Economics","Informatics","Sport"],
"Info":["Math","Informatics","Physics","Arabic","Chemistry","Biology","French","Economics","History","Sport"],
"Science":["Math","Physics","Chemistry","Biology","Arabic","Informatics","French","Economics","History","Sport"],
"Sport":["Sport","Biology","Arabic","Math","Physics","Chemistry","French","Informatics","Economics","History"],
"Technique":["Math","Physics","Chemistry","Arabic","Informatics","French","Biology","Economics","History","Geography","Sport"],
"Math":["Math","Physics","Arabic","Chemistry","Biology","French","Informatics","Economics","History","Geography","Sport"]
}
};

function updateSections(){let year=document.getElementById("problemYear").value;let sectionSelect=document.getElementById("problemSection");sectionSelect.innerHTML='<option value="">اختر الشعبة</option>';if(year && yearSections[year]){yearSections[year].forEach(sec=>{sectionSelect.innerHTML+=`<option value="${sec}">${sec}</option>`;});} updateSubjects();}
function updateSubjects(){let year=document.getElementById("problemYear").value;let section=document.getElementById("problemSection").value;let subjectSelect=document.getElementById("problemSubject");subjectSelect.innerHTML='<option value="">اختر المادة</option>';if(year=="1ère"){subjectsBySection["1ère"].forEach(sub=>{subjectSelect.innerHTML+=`<option value="${sub}">${sub}</option>`;});}else if(year && section && subjectsBySection[year] && subjectsBySection[year][section]){subjectsBySection[year][section].forEach(sub=>{subjectSelect.innerHTML+=`<option value="${sub}">${sub}</option>`;});}}

// تسجيل الحساب
function register() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const displayName = document.getElementById("displayName").value.trim();
    if(email && password && displayName){
        firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;

            // حفظ الاسم في Firebase Database
            db.ref("users/" + user.uid).set({
                name: displayName,
                email: user.email
            });

            user.sendEmailVerification()
            .then(() => {
                alert("تم إرسال رسالة تحقق إلى بريدك الإلكتروني. يرجى التحقق قبل استخدام المنصة.");
            });
        })
        .catch((error) => { alert(error.message); });
    } else { alert("الرجاء إدخال جميع الحقول"); }
}

// إعادة إرسال التحقق
function resendVerification() {
    const user = firebase.auth().currentUser;
    if(user){
        user.sendEmailVerification().then(()=>{alert("تم إعادة إرسال رسالة التحقق.");});
    } else { alert("يجب تسجيل الدخول أولاً"); }
}

// تسجيل الدخول
function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    if(email && password){
        firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;

            if(!user.emailVerified){
                alert("يرجى تأكيد بريدك الإلكتروني أولاً!");
                firebase.auth().signOut();
                return;
            }

            // جلب الاسم من Firebase Database
            db.ref("users/" + user.uid).once("value").then(snapshot => {
                const data = snapshot.val();
                currentUser = {
                    email: user.email,
                    name: data.name,
                    isAdmin: (user.email===adminEmail)
                };
                localStorage.setItem("currentUser", JSON.stringify(currentUser));
                showPlatform();
            });
        })
        .catch((error) => { alert(error.message); });
    } else { alert("الرجاء إدخال جميع الحقول"); }
}

// تسجيل الخروج
function logout() {
    firebase.auth().signOut().then(() => {
        localStorage.removeItem("currentUser");
        location.reload();
    });
}

// إذا كان المستخدم Admin
function isAdmin(){ return currentUser && currentUser.isAdmin; }

// عرض الصفحة بعد تسجيل الدخول
function showPlatform(){
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("mainPage").classList.remove("hidden");
    document.getElementById("userArea").innerHTML="مرحباً "+currentUser.name+" <button onclick='logout()'>تسجيل الخروج</button>";
    renderProblems();
}

// إضافة مشكلة
function addProblem(){
    let text=document.getElementById("problemText").value.trim();
    let price=document.getElementById("problemPrice").value.trim();
    let year=document.getElementById("problemYear").value;
    let section=document.getElementById("problemSection").value;
    let subject=document.getElementById("problemSubject").value;

    if(text && price && year && section!=null && subject){
        let newRef=db.ref("problems").push();
        newRef.set({
            user: currentUser.name,
            text:text,
            price:price,
            schoolYear:year,
            section:section,
            subject:subject,
            solutions:{},
            timestamp:Date.now()
        }).then(()=>{ document.getElementById("problemText").value=""; document.getElementById("problemPrice").value=""; document.getElementById("problemYear").value=""; document.getElementById("problemSection").innerHTML='<option value="">اختر الشعبة</option>'; document.getElementById("problemSubject").innerHTML='<option value="">اختر المادة</option>'; });
    } else { alert("الرجاء ملء جميع الحقول"); }
}

// إضافة حل
function addSolution(problemId){
    let solutionText=document.getElementById("solution"+problemId).value.trim();
    let contactText=document.getElementById("contact"+problemId).value.trim();
    let priceText=document.getElementById("price"+problemId).value.trim();

    if(solutionText && contactText && priceText){
        let newSolutionRef=db.ref("problems/"+problemId+"/solutions").push();
        newSolutionRef.set({
            solver:currentUser.name,
            solution:solutionText,
            contact:contactText,
            price:priceText
        }).then(()=>{ renderProblems(); });
    } else { alert("الرجاء ملء كل الحقول لإرسال الحل"); }
}

// حذف مشكلة وحل (Admin فقط)
function deleteProblem(id){ if(isAdmin()){ if(confirm("هل أنت متأكد من حذف هذه المشكلة؟")) db.ref("problems/"+id).remove(); } else alert("ليست لديك صلاحية"); }
function deleteSolution(problemId, solId){ if(isAdmin()){ if(confirm("هل تريد حذف هذا الحل؟")) db.ref("problems/"+problemId+"/solutions/"+solId).remove(); } else alert("ليست لديك صلاحية"); }

// عرض المشاكل
function renderProblems(){
    let list=document.getElementById("problemsList");
    list.innerHTML="";
    db.ref("problems").orderByChild("timestamp").on("value", snapshot=>{
        list.innerHTML="";
        snapshot.forEach(snap=>{
            let p=snap.val();
            let id=snap.key;
            let solutionsHTML="";
            if(p.solutions){Object.entries(p.solutions).forEach(([solId,sol])=>{
                let solutionColor=getRandomColor();
                solutionsHTML+=`<div class="solutionCard" style="background:${solutionColor}"><b>الحل بواسطة:</b> ${sol.solver} ${isAdmin() ? `<button onclick="deleteSolution('${id}','${solId}')">حذف</button>` : ""}<br><b>الحل:</b> ${sol.solution}<br><b>وسيلة التواصل:</b> ${sol.contact}<br><b>المبلغ مقابل الحل:</b> ${sol.price}</div>`;
            });}
            let cardColor=getRandomColor();
            list.innerHTML+=`<div class="card" style="background:${cardColor}"><b>المشكلة من:</b> ${p.user} (${timeSince(p.timestamp)}) ${isAdmin() ? `<button onclick="deleteProblem('${id}')">حذف</button>` : ""}<br><b>الوصف:</b> ${p.text}<br><b>المبلغ المطلوب:</b> ${p.price}<br><b>السنة:</b> ${p.schoolYear || "-"}<br><b>الشعبة:</b> ${p.section || "-"}<br><b>المادة:</b> ${p.subject || "-"}<br>${solutionsHTML}<input id="solution${id}" placeholder="اكتب الحل"><input id="contact${id}" placeholder="وسيلة التواصل"><input id="price${id}" placeholder="المبلغ مقابل الحل"><button onclick="addSolution('${id}')">إرسال الحل</button></div>`;
        });
    });
}

// إذا كان المستخدم مسجل من قبل
let savedUser = localStorage.getItem("currentUser");
if(savedUser){
    currentUser = JSON.parse(savedUser);
    showPlatform();
}

/* ------------------ Private Messaging ------------------ */
const dmRef = db.ref("privateMessages"); // Firebase node for private messages
let currentChatUser = null;

function openDM() {
    document.getElementById("dmSidebar").classList.remove("hidden");
    document.getElementById("dmSidebar").style.transform = "translateX(0)";
    loadDMUsers();
}

function closeDM() {
    document.getElementById("dmSidebar").style.transform = "translateX(100%)";
}

function loadDMUsers() {
    const listDiv = document.getElementById("dmUsersList");
    listDiv.innerHTML = "";
    dmRef.once("value").then(snapshot => {
        let usersSet = new Set();
        snapshot.forEach(snap => {
            const msg = snap.val();
            if(msg.from === currentUser.name) usersSet.add(msg.to);
            if(msg.to === currentUser.name) usersSet.add(msg.from);
        });
        usersSet.forEach(user => {
            let btn = document.createElement("button");
            btn.style.display="block";
            btn.style.width="100%";
            btn.style.padding="10px";
            btn.style.margin="5px 0";
            btn.style.textAlign="right";
            btn.innerText = user;
            btn.onclick = ()=> openChat(user);
            listDiv.appendChild(btn);
        });
    });
}

function openChat(user) {
    currentChatUser = user;
    const chatDiv = document.getElementById("dmChatArea");
    chatDiv.innerHTML = "";
    
    const inputDiv = document.createElement("div");
    inputDiv.style.display="flex";
    inputDiv.style.marginTop="auto";

    const msgInput = document.createElement("input");
    msgInput.style.flex="1";
    msgInput.style.padding="8px";
    msgInput.placeholder="اكتب رسالتك هنا...";
    msgInput.id = "dmMessageInput";

    const sendBtn = document.createElement("button");
    sendBtn.innerText="إرسال";
    sendBtn.onclick = ()=> sendDM();

    inputDiv.appendChild(msgInput);
    inputDiv.appendChild(sendBtn);
    chatDiv.appendChild(inputDiv);

    dmRef.orderByChild("timestamp").on("value", snapshot => {
        chatDiv.innerHTML = "";
        snapshot.forEach(snap=>{
            const msg = snap.val();
            if((msg.from===currentUser.name && msg.to===user) || (msg.to===currentUser.name && msg.from===user)){
                let div = document.createElement("div");
                div.style.background = (msg.from===currentUser.name) ? "#60a5fa" : "#f3f4f6";
                div.style.color = (msg.from===currentUser.name) ? "white":"black";
                div.style.padding="8px";
                div.style.margin="5px 0";
                div.style.borderRadius="10px";
                div.innerText = `${msg.from}: ${msg.text}`;
                chatDiv.appendChild(div);
            }
        });
        chatDiv.appendChild(inputDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    });
}

function sendDM() {
    const input = document.getElementById("dmMessageInput");
    const text = input.value.trim();
    if(currentChatUser && text){
        dmRef.push({
            from: currentUser.name,
            to: currentChatUser,
            text:text,
            timestamp:Date.now()
        });
        input.value="";
    }
}
</script>
</body>
</html>
