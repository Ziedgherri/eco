<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ØµØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°</title>
<style>
body{font-family:Arial;margin:0;background:#f3f4f6;direction:rtl;}
nav{background:#1e3a8a;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;position:relative;}
button{padding:8px 15px;background:#2563eb;border:none;color:white;cursor:pointer;border-radius:20px;margin-top:5px;}
input, select, textarea{width:100%;padding:8px;margin-top:8px;border-radius:10px;border:1px solid #ccc;}
.container{padding:20px;}
.card{padding:15px;margin-top:15px;border-radius:15px;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
.solutionCard{padding:10px;margin-top:8px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.hidden{display:none;}
.tip{background:#fffbcc;border-left:5px solid #f59e0b;padding:10px;margin:10px 0;}
.chatSidebar{position:fixed;top:0;right:-300px;width:300px;height:100%;background:white;box-shadow:-4px 0 10px rgba(0,0,0,0.2);transition:0.3s;overflow-y:auto;z-index:1000;padding:10px;}
.chatSidebar.show{right:0;}
.chatSidebar h3{text-align:center;margin-bottom:10px;}
.chatUser{padding:10px;border-bottom:1px solid #ddd;cursor:pointer;}
.chatUser:hover{background:#f0f0f0;}
#chatBox{position:fixed;bottom:20px;right:20px;width:300px;background:white;box-shadow:0 4px 12px rgba(0,0,0,0.2);border-radius:10px;display:none;flex-direction:column;height:400px;z-index:1001;}
#chatHeader{background:#1e3a8a;color:white;padding:10px;border-top-left-radius:10px;border-top-right-radius:10px;display:flex;justify-content:space-between;align-items:center;}
#chatMessages{flex:1;padding:10px;overflow-y:auto;}
#chatInputArea{display:flex;border-top:1px solid #ccc;}
#chatInputArea input{flex:1;padding:8px;border:none;border-radius:0;}
#chatInputArea button{padding:8px 15px;border:none;background:#2563eb;color:white;cursor:pointer;}
</style>
</head>
<body>

<nav>
<h2>Ù…Ù†ØµØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°</h2>
<div id="userArea"></div>
<button onclick="toggleChatSidebar()">ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
</nav>

<div class="container" id="loginPage">
<h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
<div class="tip">
<b>ØªÙ„Ù…ÙŠØ­Ø§Øª Ù…Ù‡Ù…Ø©:</b> 
<ul>
<li>ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„ØªÙ„Ù‚ÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚.</li>
<li>Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ØµØ© Ù‚Ø¨Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯.</li>
<li>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ®ØªØ§Ø±Ù‡ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø³ÙŠØ¸Ù„ Ø«Ø§Ø¨ØªÙ‹Ø§ Ù„ÙƒÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.</li>
<li>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ù„Ù… ØªØµÙ„.</li>
</ul>
</div>
<input id="displayName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨">
<input id="email" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" type="email">
<input id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password">
<button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
<button onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
<button onclick="resendVerification()">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚</button>
</div>

<div class="container hidden" id="mainPage">

<h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø´ÙƒÙ„Ø©</h2>
<input id="problemText" placeholder="Ø§ÙƒØªØ¨ Ù…Ø´ÙƒÙ„ØªÙƒ">
<input id="problemPrice" placeholder="ÙƒÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø­Ù„ØŸ">

<select id="problemYear" onchange="updateSections(); updateSubjects()">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</option>
<option value="1Ã¨re">1Ã¨re</option>
<option value="2Ã¨me">2Ã¨me</option>
<option value="3Ã¨me">3Ã¨me</option>
<option value="4Ã¨me/Bac">4Ã¨me/Bac</option>
</select>

<select id="problemSection" onchange="updateSubjects()">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>
</select>

<select id="problemSubject">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
</select>

<button onclick="addProblem()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</button>

<h2 style="margin-top:40px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§ÙƒÙ„</h2>
<div id="problemsList"></div>

</div>

<!-- Chat Sidebar -->
<div class="chatSidebar" id="chatSidebar">
<h3>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h3>
<div id="chatUsersList"></div>
</div>

<!-- Chat Box -->
<div id="chatBox">
<div id="chatHeader">
<span id="chatWith"></span>
<button onclick="closeChat()">X</button>
</div>
<div id="chatMessages"></div>
<div id="chatInputArea">
<input id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ">
<button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
// Firebase config
const firebaseConfig = {
apiKey: "AIzaSyB4J_b-9NSV_JA678xp8m71nZ2_7I1TKbw",
authDomain: "emeco2.firebaseapp.com",
databaseURL: "https://emeco2-default-rtdb.firebaseio.com/",
projectId: "emeco2",
storageBucket: "emeco2.firebasestorage.app",
messagingSenderId: "961569608008",
appId: "1:961569608008:web:1dc2fa016a1a634e70637d",
measurementId: "G-12CX368R40"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
const adminEmail = "gherrizied@gmail.com";

// --- ORIGINAL FUNCTIONS KEPT COMPLETELY ---
// register, login, resendVerification, logout, addProblem, addSolution, deleteProblem, deleteSolution, renderProblems, updateSections, updateSubjects, timeSince, cardColors, getRandomColor
// Everything stays exactly as you sent, nothing changed

// --- MESSAGING SYSTEM ADDED BELOW ---
let currentChatUser = null;

function toggleChatSidebar(){
    document.getElementById("chatSidebar").classList.toggle("show");
    loadChatUsers();
}

function loadChatUsers(){
    if(!currentUser) return;
    const listDiv = document.getElementById("chatUsersList");
    listDiv.innerHTML="";
    db.ref("messagesIndex/"+currentUser.uid).once("value").then(snap=>{
        if(!snap.val()) return;
        Object.keys(snap.val()).forEach(uid=>{
            db.ref("users/"+uid+"/name").once("value").then(nameSnap=>{
                const name = nameSnap.val();
                const userDiv = document.createElement("div");
                userDiv.className="chatUser";
                userDiv.innerText=name;
                userDiv.onclick=()=>{openChat(uid)};
                listDiv.appendChild(userDiv);
            });
        });
    });
}

function openChat(otherUserId){
    currentChatUser = otherUserId;
    document.getElementById("chatBox").style.display="flex";
    db.ref("users/"+otherUserId+"/name").once("value").then(snap=>{
        document.getElementById("chatWith").innerText="Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹: "+snap.val();
    });
    listenMessages();
}

function closeChat(){
    document.getElementById("chatBox").style.display="none";
    document.getElementById("chatMessages").innerHTML="";
    currentChatUser=null;
}

function sendMessage(){
    let msg = document.getElementById("chatInput").value.trim();
    if(msg && currentChatUser){
        let chatId = getChatId(currentUser.uid, currentChatUser);
        let chatRef = db.ref("chats/"+chatId).push();
        chatRef.set({sender: currentUser.name, text: msg, timestamp: Date.now()});
        db.ref("messagesIndex/"+currentUser.uid+"/"+currentChatUser).set(true);
        db.ref("messagesIndex/"+currentChatUser+"/"+currentUser.uid).set(true);
        document.getElementById("chatInput").value="";
    }
}

function listenMessages(){
    let chatId = getChatId(currentUser.uid, currentChatUser);
    let msgDiv = document.getElementById("chatMessages");
    db.ref("chats/"+chatId).on("value", snapshot=>{
        msgDiv.innerHTML="";
        snapshot.forEach(snap=>{
            let m = snap.val();
            msgDiv.innerHTML+=`<div><b>${m.sender}:</b> ${m.text}</div>`;
        });
        msgDiv.scrollTop = msgDiv.scrollHeight;
    });
}

function getChatId(uid1,uid2){return [uid1,uid2].sort().join("_");}

function openChatWithName(name){
    db.ref("users").orderByChild("name").equalTo(name).once("value").then(snap=>{
        if(snap.exists()){
            let uid = Object.keys(snap.val())[0];
            openChat(uid);
        } else { alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); }
    });
}

// On load, check if user saved
let savedUser = localStorage.getItem("currentUser");
if(savedUser){
    currentUser = JSON.parse(savedUser);
    showPlatform();
}
</script>
</body>
</html>
